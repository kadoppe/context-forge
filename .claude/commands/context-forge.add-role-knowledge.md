---
description: 職能（ロール）ごとの知見をClaude Codeプラグインとして追加・更新する
---

# ロール知見プラグイン生成コマンド

このコマンドは、チームの職能（ロール）ごとの知見をClaude Codeプラグインとして対話的に作成・更新します。

## 実行前の準備

最新のClaude Code公式ドキュメントを参照して、プラグイン仕様に準拠したファイルを生成します。

以下のドキュメントをWebFetchで取得してください（取得失敗時は警告を表示して続行）:

1. https://code.claude.com/docs/en/plugins - プラグイン構造
2. https://code.claude.com/docs/en/sub-agents - Sub Agent仕様
3. https://code.claude.com/docs/en/skills - Skill仕様
4. https://code.claude.com/docs/en/hooks-guide - Hook仕様

**重要**: ドキュメント取得に失敗した場合は、以下の警告を表示して続行してください:
> ⚠️ 公式ドキュメントの取得に失敗しました。キャッシュまたは内蔵の仕様に基づいて続行します。

---

## Phase 1: ロールの選択

まず、`.claude/plugins/` ディレクトリをスキャンして既存のロールプラグインを検索してください。
context-forge で生成したプラグインは `context-forge.role-{role-name}` という命名規則に従います。

### 既存プラグインがある場合

以下の形式で一覧を表示:

```
## ロールの選択

以下の既存ロールが見つかりました:

| # | ロール名 | 説明 | 知見数 |
|---|----------|------|--------|
| 1 | {role-name} | {description} | {count} |

選択肢:
- 番号を入力: 既存ロールに知見を追加
- "new": 新規ロールを作成
- "cancel": キャンセル
```

### 既存プラグインがない場合

新規ロール作成フロー（Phase 2）に進みます。

---

## Phase 2: 新規ロールの作成

### ロール名の入力

ユーザーにロール名を尋ねてください:

```
## 新規ロールの作成

### ロール名
ロールの識別名を入力してください（例: frontend-engineer, devops-lead）

Format: 小文字英数字とハイフンのみ (最大64文字)
```

**バリデーション**:
- パターン: `^[a-z0-9-]+$`
- 最大長: 64文字
- 無効な場合はエラーを表示して再入力を促す

### ロールの説明

```
### ロールの説明
このロールの役割と専門領域を簡潔に説明してください。

例: "フロントエンド開発のベストプラクティスとReact/TypeScriptの知見を持つ"
```

---

## Phase 3: 知見の入力

```
## 知見の追加

追加したい知見やスキルを説明してください。

例:
- "コードレビューで確認すべきチェックリスト"
- "設計ドキュメントを自動生成する"
- "セキュリティ観点でコードを自律的にレビューする"
- "コミット前にリンターを実行してチェックする"

複数の知見を追加する場合は、1つずつ処理します。
```

---

## Phase 4: 知見タイプの判定

ユーザーの入力を分析し、最適な実装タイプを判定してください。

### タイプ判定ガイドライン

| パターン | 推奨タイプ | 理由 |
|---------|-----------|------|
| 参照情報、チェックリスト、ガイドライン、ベストプラクティス | **Skill** | Claudeが必要時に自動参照 |
| ワークフロー自動化、ファイル生成、定型作業 | **Command** | ユーザーが明示的に呼び出し |
| 自律的な分析、レビュー、判断が必要なタスク | **Sub Agent** | 複雑なタスクを自律遂行 |
| イベントトリガー、検証、ガード処理 | **Hook** | 特定タイミングで自動実行 |

### 判定結果の表示

```
## 知見タイプの判定

入力: "{user-input}"

**推奨タイプ**: {recommended-type}
**理由**: {reason}

| タイプ | 説明 | この知見に適している理由 |
|--------|------|------------------------|
| A: Skill | 参照情報として自動活用 | {reason-if-applicable} |
| B: Command | スラッシュコマンドで実行 | {reason-if-applicable} |
| C: Sub Agent | 自律的なタスク遂行 | {reason-if-applicable} |
| D: Hook | イベント駆動で自動実行 | {reason-if-applicable} |

推奨を採用する場合は "yes"、変更する場合はA-Dを入力してください。
```

### 判定に自信がない場合

複数のタイプが適切な可能性がある場合は、ユーザーに選択を促してください。

---

## Phase 5: ファイル生成

選択されたタイプに応じて、適切なファイルを生成します。

### ディレクトリ構造

プラグインは `.claude/plugins/context-forge.role-{role-name}/` に生成します。

```
.claude/plugins/context-forge.role-{role-name}/
├── .claude-plugin/
│   └── plugin.json
├── commands/
│   └── {knowledge-item}.md
├── agents/
│   └── {knowledge-item}.md
├── skills/
│   └── {knowledge-item}/
│       └── SKILL.md
└── hooks/
    └── hooks.json
```

### plugin.json テンプレート

```json
{
  "name": "context-forge.role-{role-name}",
  "description": "{role-description}",
  "version": "1.0.0",
  "author": {
    "name": "Generated by context-forge"
  }
}
```

### Skill ファイルテンプレート

```markdown
---
name: {knowledge-name}
description: {description}。{trigger-condition}時に参照。
---

{content}
```

### Command ファイルテンプレート

```markdown
---
description: {description}
---

{content}
```

### Sub Agent ファイルテンプレート

```markdown
---
name: {knowledge-name}
description: {description}
tools: Read, Write, Grep, Glob
model: sonnet
---

{content}
```

### Hook 設定 (hooks.json)

```json
{
  "hooks": {
    "{event-type}": [
      {
        "matcher": "{tool-name}",
        "hooks": [
          {
            "type": "command",
            "command": "{script-path}"
          }
        ]
      }
    ]
  }
}
```

---

## Phase 6: 継続確認

```
## 知見を追加しました

作成したファイル:
- {created-file-path}

次のアクション:
- "add": さらに知見を追加
- "done": 完了してプラグインを確定
- "cancel": 変更を破棄
```

- "add" の場合: Phase 3 に戻る
- "done" の場合: Phase 7 に進む
- "cancel" の場合: 作成したファイルを削除して終了

---

## Phase 7: 完了とプラグイン有効化

### 7.1: settings.json への登録

プラグインを有効化するため、`.claude/settings.json` に自動登録します。

1. `.claude/settings.json` を読み込む（存在しない場合は新規作成）
2. 以下の設定を追加・マージ:

```json
{
  "extraKnownMarketplaces": {
    "local": {
      "source": {
        "source": "local",
        "path": "./.claude/plugins"
      }
    }
  },
  "enabledPlugins": {
    "context-forge.role-{role-name}@local": true
  }
}
```

3. 既存の設定がある場合はマージして保存

**重要**:
- `extraKnownMarketplaces.local` はローカルプラグインのマーケットプレイス定義です
- 既存の `enabledPlugins` 設定を上書きせず、新しいエントリを追加してください
- 既に `extraKnownMarketplaces.local` が存在する場合は追加不要です

### 7.2: 完了メッセージ

```
## プラグイン生成完了

### 作成されたプラグイン

**ロール**: {role-name}
**場所**: .claude/plugins/context-forge.role-{role-name}/

**構成**:
{tree-structure}

### プラグイン有効化

`.claude/settings.json` に以下を追加しました:
```json
{
  "extraKnownMarketplaces": {
    "local": {
      "source": {
        "source": "local",
        "path": "./.claude/plugins"
      }
    }
  },
  "enabledPlugins": {
    "context-forge.role-{role-name}@local": true
  }
}
```

### 次のステップ

1. Claude Codeを再起動してプラグインをロード
2. プラグインが認識されると、追加した知見が自動的に利用可能になります
3. Skillは関連するタスクで自動参照されます
4. Commandは `/context-forge.role-{role-name}.{command-name}` で実行できます
5. Sub Agentは Task ツールで呼び出せます
```

---

## エラーハンドリング

| エラー | 対応 |
|--------|------|
| ロール名が無効 | 形式エラーを表示し再入力を促す |
| 既存プラグインと競合 | 更新フローへ誘導 |
| ドキュメント取得失敗 | 警告表示 + 内蔵仕様で続行 |
| ファイル書き込み失敗 | エラー表示 + 権限確認ヒント |
| キャンセル | 作成中のファイルを削除して終了 |

---

## 既存プラグインへの知見追加

既存のロールを選択した場合:

1. 既存の plugin.json を読み込み
2. 既存の知見一覧を表示
3. Phase 3 から開始
4. hooks.json が既に存在する場合は追記（上書きしない）
