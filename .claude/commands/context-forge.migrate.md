---
description: 既存の context-forge role plugin を最新仕様に更新する
---

# Role Plugin マイグレーションコマンド

このコマンドは、以前のバージョンの context-forge で作成した role plugin を最新の仕様に更新します。

## コマンド引数

```
$ARGUMENTS
```

引数が指定されている場合は、その名前のプラグインのみを対象とします。
引数が空の場合は、すべての context-forge role plugin を対象とします。

---

## Phase 0: 最新仕様の理解

**重要**: マイグレーションを実行する前に、最新の context-forge 仕様を理解する必要があります。

### 最新仕様の参照元

`.claude/commands/` ディレクトリ内の `context-forge.*.md` ファイル（このコマンド `context-forge.migrate.md` を除く）をすべて読み込んで、最新のプラグイン仕様を理解してください。

### 読み込み手順

```
1. .claude/commands/ ディレクトリをスキャン
2. context-forge.*.md パターンに一致するファイルを列挙
3. context-forge.migrate.md を除外
4. 残りのファイルをすべて Read ツールで読み込む
5. 各ファイルから以下のセクションを特に注意して理解する:
   - plugin.json テンプレート
   - Skill ファイルテンプレート（description のトリガー表現形式）
   - Sub Agent ファイルテンプレート（description のトリガー表現形式）
   - Command ファイルテンプレート
   - Hook 設定
```

### 理解すべきポイント

読み込んだ仕様から、以下を把握してください:

1. **Skill の description 形式**: トリガー表現（「〜について質問・相談した場合に参照すること」）の書き方
2. **SubAgent の description 形式**: トリガー表現（「〜と言った場合にこのSubAgentを使用すること」）の書き方
3. **必須フィールド**: 各コンポーネントで必須となるフィールド
4. **品質ルール**: SubAgent のコマンド記述ルール（プレースホルダー禁止、変数クォーティングなど）

**注意**: context-forge.*.md ファイルが1つも見つからない場合（migrate.md 以外）は、エラーを表示して終了してください:

```
## エラー: 仕様ファイルが見つかりません

context-forge のコマンドファイルが見つかりません。

`context-forge init` を実行して、最新のコマンドファイルをインストールしてください。
```

---

## Phase 1: プラグイン検出

`.claude/plugins/` ディレクトリをスキャンして、context-forge で生成された role plugin を検出してください。

### 検出パターン

ディレクトリ名が `context-forge.role-*` パターンに一致するものを対象とします。

```bash
# 検出対象のパターン
.claude/plugins/context-forge.role-{role-name}/
```

### 検出手順

1. `.claude/plugins/` ディレクトリが存在するか確認
2. `context-forge.role-*` パターンに一致するディレクトリを列挙
3. 各ディレクトリ内に `.claude-plugin/plugin.json` が存在するか確認

### 引数によるフィルタリング

`$ARGUMENTS` が空でない場合:
- 引数で指定されたロール名（例: `software-engineer`）と一致するプラグインのみを対象とする
- フルネーム（`context-forge.role-software-engineer`）でも、ロール名のみ（`software-engineer`）でもマッチさせる
- 一致するプラグインが見つからない場合は、以下のメッセージを表示して終了:

```
## エラー: プラグインが見つかりません

指定されたプラグイン "{引数}" は見つかりませんでした。

利用可能なプラグイン:
- context-forge.role-{name1}
- context-forge.role-{name2}
...

プラグイン名を確認して再度実行してください。
```

### プラグインが見つからない場合

対象のプラグインが1つも見つからない場合は、以下のメッセージを表示して終了:

```
## マイグレーション対象なし

context-forge で生成された role plugin が見つかりませんでした。

プラグインは `.claude/plugins/context-forge.role-{role-name}/` に配置されている必要があります。

新しいプラグインを作成するには、`/context-forge.add-role-knowledge` コマンドを使用してください。
```

---

## Phase 2: 現状分析と更新判定

検出した各プラグインについて、Phase 0 で理解した最新仕様と比較して、更新が必要かどうかを判定してください。

### 分析対象

各プラグインの以下のファイルを読み込んで分析:

1. `.claude-plugin/plugin.json`
2. `agents/*.md`（存在する場合）
3. `skills/*/SKILL.md`（存在する場合）
4. `commands/*.md`（存在する場合）
5. `hooks/hooks.json`（存在する場合）

### 更新が必要な条件

以下のいずれかに該当する場合、そのコンポーネントは更新が必要です:

#### agents/*.md
- description にトリガー表現が含まれていない
  - トリガー表現の例: 「〜と言った場合にこのSubAgentを使用すること」
- 必須セクション（実行手順、トラブルシューティング、注意事項）が不足している
- コマンド例にプレースホルダー（`<xxx>`, `{xxx}`）が残っている

#### skills/*/SKILL.md
- description にトリガー表現が含まれていない
  - トリガー表現の例: 「〜について質問・相談した場合に参照すること」

#### commands/*.md
- frontmatter に description フィールドがない

#### plugin.json
- 上記のいずれかのコンポーネントが更新された場合、version も更新が必要

### 更新不要の場合

すべてのプラグインが最新仕様に準拠している場合:

```
## すべてのプラグインは最新です

検出されたすべての role plugin は最新の仕様に準拠しています。

マイグレーションは不要です。
```

---

## Phase 3: マイグレーション実行

更新が必要なプラグインについて、Phase 0 で理解した最新仕様に基づいて更新を実行してください。

### 更新の原則

1. **Phase 0 で読み込んだ仕様に準拠**: 読み込んだコマンドファイルの仕様に従って更新
2. **既存コンテンツの保持**: 元の内容を可能な限り保持しつつ、不足部分を補完
3. **一貫性の確保**: 同じプラグイン内のコンポーネント間で形式を統一

### 3.1: agents/*.md の更新

Phase 0 で理解した SubAgent テンプレートに基づいて更新:

1. **description にトリガー表現を追加**
   - 元の description の内容を保持
   - 「ユーザーが「〜」「〜」「〜」と言った場合にこのSubAgentを使用すること」を追加
   - トリガー表現は最低3つ、SubAgent の機能から適切に生成

2. **必須セクションの追加**（不足している場合）
   - `## 実行手順`
   - `## トラブルシューティング`
   - `## 注意事項`

3. **コマンド例の修正**
   - プレースホルダー（`<xxx>`, `{xxx}`）を動的コマンドに置換
   - 変数を適切にクォート（`"$VAR"`）

### 3.2: skills/*/SKILL.md の更新

Phase 0 で理解した Skill テンプレートに基づいて更新:

1. **description にトリガー表現を追加**
   - 元の description の内容を保持
   - 「ユーザーが「〜」「〜」「〜」について質問・相談した場合に参照すること」を追加
   - トリガー表現は最低3つ、Skill の内容から適切に生成

### 3.3: commands/*.md の更新

1. **frontmatter に description を追加**（存在しない場合）
   - コマンドの内容から適切な description を生成

### 3.4: hooks/hooks.json の確認

1. **構造の検証**のみ実行
2. 不正な構造の場合は警告を表示（自動修正は行わない）

### 3.5: plugin.json の更新

上記のいずれかのコンポーネントが更新された場合:
- 既存の name, description, author は保持
- version を context-forge の最新バージョンに更新

**バージョン取得手順:**
1. プロジェクトルートの `pyproject.toml` を読み込む
2. `version = "X.Y.Z"` の値を抽出
3. plugin.json の version をその値に更新

### エラー発生時の処理

マイグレーション中にエラーが発生した場合:

1. エラー内容を記録
2. 該当プラグインの処理を中断
3. 他のプラグインの処理は継続

```
## 警告: マイグレーション失敗

プラグイン "{plugin-name}" のマイグレーション中にエラーが発生しました。

エラー内容: {error-message}

このプラグインはスキップされました。手動で修正してください。
```

---

## Phase 4: マイグレーションレポート

マイグレーション完了後、以下の形式でレポートを表示してください。

### レポート形式

```
## マイグレーション完了

### サマリー

| 項目 | 数 |
|------|-----|
| 検出されたプラグイン | {total} |
| 更新されたプラグイン | {migrated} |
| スキップ（最新） | {skipped} |
| エラー | {errors} |

### 更新されたプラグイン

{更新されたプラグインがある場合}
- **context-forge.role-{name1}**
  - 更新されたファイル:
    - agents/pr-review-assistant.md（トリガー表現追加）
    - skills/code-review/SKILL.md（トリガー表現追加）

{更新されたプラグインがない場合}
なし

### スキップされたプラグイン

{スキップされたプラグインがある場合}
- context-forge.role-{name2}（すでに最新）

{スキップされたプラグインがない場合}
なし

### エラー

{エラーがある場合}
- context-forge.role-{name3}: {error-message}

{エラーがない場合}
なし

### 次のステップ

1. 更新されたプラグインが正しく動作することを確認してください
2. Claude Code を再起動して、更新されたプラグインをロードしてください
```

### 対象プラグインが指定されていた場合

引数でプラグインが指定されていた場合は、レポートの冒頭に以下を追加:

```
**対象プラグイン**: {指定されたプラグイン名}
```

---

## 注意事項

- **仕様の参照**: 最新仕様は常に context-forge.*.md コマンドファイルから取得するため、仕様が更新されても migrate コマンドは自動的に対応します
- **コンテンツ保持**: 既存の description やコンテンツは保持しつつ、不足部分を補完します
- **hooks は検証のみ**: hooks.json は構造の検証のみ行い、内容の自動修正は行いません
- **手動カスタマイズの保持**: 手動で追加したカスタマイズは可能な限り保持されます
